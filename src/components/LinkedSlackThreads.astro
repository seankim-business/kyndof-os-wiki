---
/**
 * LinkedSlackThreads Component
 * Display Slack threads linked to an entity
 */

interface SlackThread {
  threadId: string;
  channelName: string;
  channelId: string;
  timestamp: string;
  participants: string[];
  replyCount: number;
  preview: string; // First message snippet
  url: string;
}

interface Props {
  entityId: string;
  threads?: SlackThread[];
}

const { entityId, threads = [] } = Astro.props;

// Format timestamp
function formatDate(timestamp: string): string {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Truncate preview
function truncate(text: string, maxLength: number = 100): string {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength).trim() + '...';
}
---

<section class="linked-slack">
  <div class="section-header">
    <div class="header-content">
      <svg class="slack-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="7" height="7" rx="1" />
        <rect x="14" y="3" width="7" height="7" rx="1" />
        <rect x="14" y="14" width="7" height="7" rx="1" />
        <rect x="3" y="14" width="7" height="7" rx="1" />
      </svg>
      <h3>Slack Threads</h3>
    </div>
    <span class="thread-count">{threads.length}</span>
  </div>

  {threads.length === 0 ? (
    <p class="empty-state">No Slack threads linked yet</p>
  ) : (
    <div class="threads-list">
      {threads.map((thread) => (
        <a href={thread.url} target="_blank" rel="noopener noreferrer" class="thread-card">
          <div class="thread-header">
            <span class="channel-name">#{thread.channelName}</span>
            <span class="thread-date">{formatDate(thread.timestamp)}</span>
          </div>
          <p class="thread-preview">{truncate(thread.preview)}</p>
          <div class="thread-meta">
            <span class="meta-item">
              <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
              </svg>
              {thread.participants.length} participant{thread.participants.length !== 1 ? 's' : ''}
            </span>
            <span class="meta-item">
              <svg class="meta-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
              </svg>
              {thread.replyCount} repl{thread.replyCount !== 1 ? 'ies' : 'y'}
            </span>
          </div>
          <div class="external-link-indicator">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
              <polyline points="15 3 21 3 21 9" />
              <line x1="10" y1="14" x2="21" y2="3" />
            </svg>
          </div>
        </a>
      ))}
    </div>
  )}
</section>

<style>
  .linked-slack {
    margin-bottom: var(--spacing-lg);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .slack-icon {
    width: 20px;
    height: 20px;
    color: #611f69; /* Slack brand purple */
  }

  .section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .thread-count {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .empty-state {
    padding: var(--spacing-lg);
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px dashed var(--border-color);
  }

  .threads-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .thread-card {
    position: relative;
    display: block;
    padding: var(--spacing-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .thread-card:hover {
    border-color: #611f69;
    background: var(--bg-primary);
    box-shadow: var(--shadow-sm);
    transform: translateX(2px);
  }

  .thread-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-xs);
  }

  .channel-name {
    font-size: 13px;
    font-weight: 600;
    color: #611f69;
  }

  .thread-date {
    font-size: 12px;
    color: var(--text-muted);
  }

  .thread-preview {
    margin: 0 0 var(--spacing-sm);
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .thread-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .meta-icon {
    width: 14px;
    height: 14px;
  }

  .external-link-indicator {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .thread-card:hover .external-link-indicator {
    opacity: 1;
  }

  .external-link-indicator svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
  }
</style>
