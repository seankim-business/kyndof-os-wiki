---
/**
 * LinkedDocuments Component
 * Display Google Drive documents linked to an entity
 */

interface DriveDocument {
  documentId: string;
  name: string;
  mimeType: string;
  url: string;
  lastModified: string;
  owner?: string;
  iconUrl?: string;
}

interface Props {
  entityId: string;
  documents?: DriveDocument[];
}

const { entityId, documents = [] } = Astro.props;

// Format timestamp
function formatDate(timestamp: string): string {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Yesterday';
  if (diffDays < 7) return `${diffDays} days ago`;
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// Get document type info based on mimeType
function getDocumentType(mimeType: string): { label: string; color: string; icon: string } {
  const types: Record<string, { label: string; color: string; icon: string }> = {
    'application/vnd.google-apps.document': {
      label: 'Doc',
      color: '#4285F4', // Google Docs blue
      icon: 'document'
    },
    'application/vnd.google-apps.spreadsheet': {
      label: 'Sheet',
      color: '#0F9D58', // Google Sheets green
      icon: 'spreadsheet'
    },
    'application/vnd.google-apps.presentation': {
      label: 'Slides',
      color: '#F4B400', // Google Slides yellow
      icon: 'presentation'
    },
    'application/pdf': {
      label: 'PDF',
      color: '#EA4335', // Red
      icon: 'pdf'
    },
    'application/vnd.google-apps.folder': {
      label: 'Folder',
      color: '#5F6368', // Gray
      icon: 'folder'
    },
  };

  return types[mimeType] || { label: 'File', color: '#5F6368', icon: 'file' };
}

// Get SVG icon for document type
function getIcon(iconType: string): string {
  const icons: Record<string, string> = {
    document: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>',
    spreadsheet: '<rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/>',
    presentation: '<rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/>',
    pdf: '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="7" y="16" font-size="6" font-weight="600" fill="currentColor">PDF</text>',
    folder: '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>',
    file: '<path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>',
  };

  return icons[iconType] || icons.file;
}
---

<section class="linked-documents">
  <div class="section-header">
    <div class="header-content">
      <svg class="drive-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
        <path d="M8 2L2 14l3 6h14l3-6L16 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round" fill="none"/>
      </svg>
      <h3>Drive Documents</h3>
    </div>
    <span class="doc-count">{documents.length}</span>
  </div>

  {documents.length === 0 ? (
    <p class="empty-state">No Drive documents linked yet</p>
  ) : (
    <div class="documents-list">
      {documents.map((doc) => {
        const docType = getDocumentType(doc.mimeType);
        return (
          <a href={doc.url} target="_blank" rel="noopener noreferrer" class="document-card">
            <div class="doc-icon-wrapper" style={`--doc-color: ${docType.color}`}>
              <svg class="doc-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <Fragment set:html={getIcon(docType.icon)} />
              </svg>
            </div>
            <div class="doc-info">
              <div class="doc-header">
                <span class="doc-name">{doc.name}</span>
                <span class="doc-type-badge" style={`background: ${docType.color}20; color: ${docType.color}`}>
                  {docType.label}
                </span>
              </div>
              <div class="doc-meta">
                <span class="doc-modified">Modified {formatDate(doc.lastModified)}</span>
                {doc.owner && (
                  <>
                    <span class="meta-separator">â€¢</span>
                    <span class="doc-owner">{doc.owner}</span>
                  </>
                )}
              </div>
            </div>
            <div class="external-link-indicator">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
              </svg>
            </div>
          </a>
        );
      })}
    </div>
  )}
</section>

<style>
  .linked-documents {
    margin-bottom: var(--spacing-lg);
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .drive-icon {
    width: 20px;
    height: 20px;
    color: #4285F4; /* Google Drive blue */
  }

  .section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .doc-count {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: var(--radius-sm);
  }

  .empty-state {
    padding: var(--spacing-lg);
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px dashed var(--border-color);
  }

  .documents-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .document-card {
    position: relative;
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .document-card:hover {
    border-color: var(--doc-color);
    background: var(--bg-primary);
    box-shadow: var(--shadow-sm);
    transform: translateX(2px);
  }

  .doc-icon-wrapper {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: color-mix(in srgb, var(--doc-color) 10%, transparent);
    border-radius: var(--radius-md);
  }

  .doc-icon {
    width: 24px;
    height: 24px;
    color: var(--doc-color);
  }

  .doc-info {
    flex: 1;
    min-width: 0;
  }

  .doc-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: 4px;
  }

  .doc-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .doc-type-badge {
    flex-shrink: 0;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    padding: 2px 6px;
    border-radius: var(--radius-sm);
  }

  .doc-meta {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .meta-separator {
    color: var(--border-color);
  }

  .doc-modified,
  .doc-owner {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .external-link-indicator {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .document-card:hover .external-link-indicator {
    opacity: 1;
  }

  .external-link-indicator svg {
    width: 16px;
    height: 16px;
    color: var(--text-muted);
  }
</style>
