---
import WikiLayout from '@layouts/WikiLayout.astro';
import Backlinks from '@components/Backlinks.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

// Generate static paths for all content
export async function getStaticPaths() {
  // Collect entries from all collections
  const collections = [
    // NEW: Importance-based collections
    '00-company', '01-projects', '02-partners-clients', '03-processes', '04-teams', '99-archive',
    // LEGACY: Database-generated collections
    'businessModels', 'companyWiki', 'departments', 'entities', 'functions',
    'goals', 'hypothesis', 'kpis', 'meetings', 'people', 'positions',
    'projects', 'results', 'strategies', 'tasks', 'companies'
  ];
  const allEntries: { params: { slug: string }; props: { entry: CollectionEntry<any>; collection: string } }[] = [];

  for (const collectionName of collections) {
    try {
      const entries = await getCollection(collectionName as any);
      for (const entry of entries) {
        allEntries.push({
          params: { slug: entry.slug },
          props: { entry, collection: collectionName },
        });
      }
    } catch {
      // Collection might not exist yet, skip
    }
  }

  // If no content yet, return empty array (will 404)
  if (allEntries.length === 0) {
    return [];
  }

  return allEntries;
}

type Props = {
  entry: CollectionEntry<
    // NEW: Importance-based collections
    | '00-company'
    | '01-projects'
    | '02-partners-clients'
    | '03-processes'
    | '04-teams'
    | '99-archive'
    // LEGACY: Database-generated collections
    | 'businessModels'
    | 'companyWiki'
    | 'departments'
    | 'entities'
    | 'functions'
    | 'goals'
    | 'hypothesis'
    | 'kpis'
    | 'meetings'
    | 'people'
    | 'positions'
    | 'projects'
    | 'results'
    | 'strategies'
    | 'tasks'
    | 'companies'
  >;
  collection: string;
};

const { entry, collection } = Astro.props;
const { Content } = await entry.render();

// Detect schema type based on collection
const isImportanceBased = ['00-company', '01-projects', '02-partners-clients', '03-processes', '04-teams', '99-archive'].includes(collection);

// Extract frontmatter data (support both schemas)
const data = entry.data as any;
const title = data.title;
const description = data.description;
const tags = data.tags || [];

// Legacy schema fields
const type = data.type;
const lastSynced = data.lastSynced;
const relations = data.relations || [];

// New importance-based schema fields
const priority = data.priority;
const lastUpdated = data.lastUpdated;
const relatedDocs = data.relatedDocs || [];

// Type badge colors (for legacy schema)
const typeColors: Record<string, { bg: string; text: string }> = {
  person: { bg: 'var(--type-person-bg)', text: 'var(--type-person)' },
  company: { bg: 'var(--type-company-bg)', text: 'var(--type-company)' },
  project: { bg: 'var(--type-project-bg)', text: 'var(--type-project)' },
  meeting: { bg: 'var(--type-meeting-bg)', text: 'var(--type-meeting)' },
  task: { bg: 'var(--type-task-bg)', text: 'var(--type-task)' },
  document: { bg: 'var(--type-document-bg)', text: 'var(--type-document)' },
};

const colors = typeColors[type] || { bg: 'var(--bg-tertiary)', text: 'var(--text-muted)' };

// Priority badge for importance-based content
const getPriorityLabel = (p: number): string => {
  if (p <= 9) return 'Critical';
  if (p <= 19) return 'High';
  if (p <= 39) return 'Medium';
  if (p <= 59) return 'Low';
  return 'Archive';
};

const getPriorityColor = (p: number): { bg: string; text: string } => {
  if (p <= 9) return { bg: '#fee', text: '#c00' };
  if (p <= 19) return { bg: '#ffefd5', text: '#d2691e' };
  if (p <= 39) return { bg: '#f0f8ff', text: '#4682b4' };
  if (p <= 59) return { bg: '#f0fff0', text: '#228b22' };
  return { bg: 'var(--bg-tertiary)', text: 'var(--text-muted)' };
};

// Mock backlinks (in production, would be computed at build time)
const backlinks: { slug: string; title: string; type?: string }[] = [];
---

<WikiLayout title={title} description={description} lastSynced={lastSynced || lastUpdated}>
  <article class="entity-page">
    <header class="entity-header">
      <div class="entity-meta">
        {isImportanceBased ? (
          <>
            <span class="entity-type" style={`background: ${getPriorityColor(priority).bg}; color: ${getPriorityColor(priority).text}`}>
              {getPriorityLabel(priority)} (P{priority})
            </span>
            {lastUpdated && (
              <span class="entity-updated">
                Updated: {lastUpdated}
              </span>
            )}
          </>
        ) : (
          <span class="entity-type" style={`background: ${colors.bg}; color: ${colors.text}`}>
            {type}
          </span>
        )}
        {tags.length > 0 && (
          <div class="entity-tags">
            {tags.map((tag: string) => (
              <span class="entity-tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
      <h1 class="entity-title">{title}</h1>
      {description && <p class="entity-description">{description}</p>}
    </header>

    {(relations.length > 0 || relatedDocs.length > 0) && (
      <section class="entity-relations">
        <h2>{isImportanceBased ? 'Related Documents' : 'Connections'}</h2>
        <ul class="relations-list">
          {isImportanceBased ? (
            relatedDocs.map((docPath: string) => (
              <li class="relation-item">
                <a href={`/${docPath}`} class="relation-link">
                  {docPath}
                </a>
              </li>
            ))
          ) : (
            relations.map((rel: { type: string; target: string; label?: string }) => (
              <li class="relation-item">
                <span class="relation-type">{rel.type}</span>
                <a href={`/${rel.target}`} class="relation-link">
                  {rel.label || rel.target}
                </a>
              </li>
            ))
          )}
        </ul>
      </section>
    )}

    <section class="entity-content">
      <Content />
    </section>

    <Backlinks currentSlug={entry.slug} backlinks={backlinks} />
  </article>
</WikiLayout>

<style>
  .entity-page {
    max-width: 100%;
  }

  .entity-header {
    margin-bottom: var(--spacing-xl);
    padding-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
  }

  .entity-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-sm);
  }

  .entity-type {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 4px 10px;
    border-radius: var(--radius-sm);
  }

  .entity-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }

  .entity-tag {
    font-size: 12px;
    padding: 2px 8px;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    border-radius: var(--radius-sm);
  }

  .entity-updated {
    font-size: 12px;
    padding: 4px 10px;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    border-radius: var(--radius-sm);
  }

  .entity-title {
    margin: 0 0 var(--spacing-sm);
    font-size: var(--text-2xl);
    line-height: 1.2;
  }

  .entity-description {
    margin: 0;
    font-size: var(--text-lg);
    color: var(--text-secondary);
    line-height: 1.5;
  }

  /* Relations */
  .entity-relations {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
  }

  .entity-relations h2 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    margin: 0 0 var(--spacing-sm);
  }

  .relations-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .relation-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .relation-type {
    font-size: 12px;
    color: var(--text-muted);
    min-width: 100px;
  }

  .relation-link {
    color: var(--link-color);
    text-decoration: none;
    font-weight: 500;
  }

  .relation-link:hover {
    text-decoration: underline;
  }

  /* Content */
  .entity-content {
    line-height: 1.7;
  }
</style>
